name: Publish Crates

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (skip actual publish)'
        required: false
        default: false
        type: boolean
  push:
    tags:
      - 'v*.*.*'

env:
  RUST_BACKTRACE: 1

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev libsasl2-dev cmake

      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Login to crates.io
        run: cargo login ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish sentinel-core
        if: ${{ !inputs.dry_run }}
        run: |
          cd crates/sentinel-core
          cargo publish --no-verify
          echo "‚úÖ Published sentinel-core"
          sleep 30

      - name: Publish sentinel-ingestion
        if: ${{ !inputs.dry_run }}
        run: |
          cd crates/sentinel-ingestion
          cargo publish --no-verify
          echo "‚úÖ Published sentinel-ingestion"
          sleep 30

      - name: Publish sentinel-detection
        if: ${{ !inputs.dry_run }}
        run: |
          cd crates/sentinel-detection
          cargo publish --no-verify
          echo "‚úÖ Published sentinel-detection"
          sleep 30

      - name: Publish sentinel-storage
        if: ${{ !inputs.dry_run }}
        run: |
          cd crates/sentinel-storage
          cargo publish --no-verify
          echo "‚úÖ Published sentinel-storage"
          sleep 30

      - name: Publish sentinel-alerting
        if: ${{ !inputs.dry_run }}
        run: |
          cd crates/sentinel-alerting
          cargo publish --no-verify
          echo "‚úÖ Published sentinel-alerting"
          sleep 30

      - name: Publish sentinel-api
        if: ${{ !inputs.dry_run }}
        run: |
          cd crates/sentinel-api
          cargo publish --no-verify
          echo "‚úÖ Published sentinel-api"
          sleep 30

      - name: Publish sentinel binary
        if: ${{ !inputs.dry_run }}
        run: |
          cd sentinel
          cargo publish --no-verify
          echo "‚úÖ Published sentinel"

      - name: Dry run - Check packages
        if: ${{ inputs.dry_run }}
        run: |
          echo "üîç Dry run mode - checking packages..."
          cd crates/sentinel-core && cargo package --list
          cd ../sentinel-ingestion && cargo package --list
          cd ../sentinel-detection && cargo package --list
          cd ../sentinel-storage && cargo package --list
          cd ../sentinel-alerting && cargo package --list
          cd ../sentinel-api && cargo package --list
          cd ../../sentinel && cargo package --list
          echo "‚úÖ All packages check passed"

      - name: Create GitHub Release
        if: ${{ !inputs.dry_run && startsWith(github.ref, 'refs/tags/') }}
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          body: |
            ## Published Crates

            - [sentinel-core v${{ github.ref_name }}](https://crates.io/crates/sentinel-core)
            - [sentinel-ingestion v${{ github.ref_name }}](https://crates.io/crates/sentinel-ingestion)
            - [sentinel-detection v${{ github.ref_name }}](https://crates.io/crates/sentinel-detection)
            - [sentinel-storage v${{ github.ref_name }}](https://crates.io/crates/sentinel-storage)
            - [sentinel-alerting v${{ github.ref_name }}](https://crates.io/crates/sentinel-alerting)
            - [sentinel-api v${{ github.ref_name }}](https://crates.io/crates/sentinel-api)
            - [sentinel v${{ github.ref_name }}](https://crates.io/crates/sentinel)

            ## Installation

            ```bash
            cargo install sentinel
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
