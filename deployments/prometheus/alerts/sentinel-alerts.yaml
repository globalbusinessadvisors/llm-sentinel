groups:
  - name: sentinel_service_health
    interval: 30s
    rules:
      - alert: SentinelServiceDown
        expr: up{job="sentinel"} == 0
        for: 1m
        labels:
          severity: critical
          component: service
        annotations:
          summary: "Sentinel service is down"
          description: "Sentinel instance {{ $labels.instance }} has been down for more than 1 minute."
          runbook_url: "https://docs.example.com/runbooks/sentinel-down"

      - alert: SentinelHighRestartRate
        expr: rate(process_start_time_seconds{job="sentinel"}[15m]) > 0.01
        for: 5m
        labels:
          severity: warning
          component: service
        annotations:
          summary: "Sentinel service is restarting frequently"
          description: "Sentinel instance {{ $labels.instance }} is restarting frequently ({{ $value }} restarts/sec)."
          runbook_url: "https://docs.example.com/runbooks/frequent-restarts"

      - alert: SentinelInsufficientInstances
        expr: count(up{job="sentinel"} == 1) < 2
        for: 5m
        labels:
          severity: warning
          component: service
        annotations:
          summary: "Insufficient Sentinel instances running"
          description: "Only {{ $value }} Sentinel instances are running. Minimum 2 required for high availability."
          runbook_url: "https://docs.example.com/runbooks/insufficient-instances"

  - name: sentinel_performance
    interval: 30s
    rules:
      - alert: SentinelHighLatency
        expr: histogram_quantile(0.95, rate(sentinel_detection_latency_seconds_bucket[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
          component: detection
        annotations:
          summary: "Sentinel detection latency is high"
          description: "P95 detection latency is {{ $value | humanizeDuration }} (threshold: 50ms)."
          runbook_url: "https://docs.example.com/runbooks/high-latency"

      - alert: SentinelVeryHighLatency
        expr: histogram_quantile(0.95, rate(sentinel_detection_latency_seconds_bucket[5m])) > 0.1
        for: 2m
        labels:
          severity: critical
          component: detection
        annotations:
          summary: "Sentinel detection latency is critically high"
          description: "P95 detection latency is {{ $value | humanizeDuration }} (threshold: 100ms)."
          runbook_url: "https://docs.example.com/runbooks/high-latency"

      - alert: SentinelLowThroughput
        expr: rate(sentinel_events_processed_total[5m]) < 100
        for: 10m
        labels:
          severity: warning
          component: ingestion
        annotations:
          summary: "Sentinel event processing throughput is low"
          description: "Processing only {{ $value | humanize }} events/sec (expected: >100/sec)."
          runbook_url: "https://docs.example.com/runbooks/low-throughput"

  - name: sentinel_errors
    interval: 30s
    rules:
      - alert: SentinelHighErrorRate
        expr: |
          sum(rate(sentinel_ingestion_errors_total[5m])
            + rate(sentinel_detection_errors_total[5m])
            + rate(sentinel_storage_errors_total[5m])) > 10
        for: 5m
        labels:
          severity: warning
          component: errors
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanize }} errors/sec across all components."
          runbook_url: "https://docs.example.com/runbooks/high-error-rate"

      - alert: SentinelIngestionErrors
        expr: rate(sentinel_ingestion_errors_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          component: ingestion
        annotations:
          summary: "High ingestion error rate"
          description: "Ingestion errors at {{ $value | humanize }} errors/sec."
          runbook_url: "https://docs.example.com/runbooks/ingestion-errors"

      - alert: SentinelDetectionErrors
        expr: rate(sentinel_detection_errors_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          component: detection
        annotations:
          summary: "High detection error rate"
          description: "Detection errors at {{ $value | humanize }} errors/sec."
          runbook_url: "https://docs.example.com/runbooks/detection-errors"

      - alert: SentinelStorageErrors
        expr: rate(sentinel_storage_errors_total[5m]) > 5
        for: 5m
        labels:
          severity: critical
          component: storage
        annotations:
          summary: "High storage error rate"
          description: "Storage errors at {{ $value | humanize }} errors/sec. Data loss possible."
          runbook_url: "https://docs.example.com/runbooks/storage-errors"

      - alert: SentinelValidationFailures
        expr: rate(sentinel_validation_failures_total[5m]) > 20
        for: 10m
        labels:
          severity: warning
          component: validation
        annotations:
          summary: "High validation failure rate"
          description: "Validation failures at {{ $value | humanize }} failures/sec. Check input data quality."
          runbook_url: "https://docs.example.com/runbooks/validation-failures"

  - name: sentinel_resources
    interval: 30s
    rules:
      - alert: SentinelHighMemoryUsage
        expr: process_resident_memory_bytes{job="sentinel"} > 1.5e9
        for: 5m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: "High memory usage"
          description: "Instance {{ $labels.instance }} using {{ $value | humanize1024 }}B of memory (threshold: 1.5GB)."
          runbook_url: "https://docs.example.com/runbooks/high-memory"

      - alert: SentinelCriticalMemoryUsage
        expr: process_resident_memory_bytes{job="sentinel"} > 1.8e9
        for: 2m
        labels:
          severity: critical
          component: resources
        annotations:
          summary: "Critical memory usage"
          description: "Instance {{ $labels.instance }} using {{ $value | humanize1024 }}B of memory (threshold: 1.8GB). OOM risk."
          runbook_url: "https://docs.example.com/runbooks/high-memory"

      - alert: SentinelHighCPUUsage
        expr: rate(process_cpu_seconds_total{job="sentinel"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          component: resources
        annotations:
          summary: "High CPU usage"
          description: "Instance {{ $labels.instance }} CPU usage at {{ $value | humanize }}%."
          runbook_url: "https://docs.example.com/runbooks/high-cpu"

  - name: sentinel_anomaly_detection
    interval: 30s
    rules:
      - alert: SentinelAnomalySpike
        expr: rate(sentinel_anomalies_detected_total[5m]) > 50
        for: 5m
        labels:
          severity: warning
          component: detection
        annotations:
          summary: "Anomaly detection spike"
          description: "Detecting {{ $value | humanize }} anomalies/sec. Investigate for systemic issues."
          runbook_url: "https://docs.example.com/runbooks/anomaly-spike"

      - alert: SentinelCriticalAnomalies
        expr: rate(sentinel_anomalies_detected_total{severity="critical"}[5m]) > 5
        for: 2m
        labels:
          severity: critical
          component: detection
        annotations:
          summary: "High rate of critical anomalies"
          description: "Detecting {{ $value | humanize }} critical anomalies/sec."
          runbook_url: "https://docs.example.com/runbooks/critical-anomalies"

      - alert: SentinelNoAnomalies
        expr: sum(increase(sentinel_anomalies_detected_total[1h])) == 0
        for: 6h
        labels:
          severity: info
          component: detection
        annotations:
          summary: "No anomalies detected for 6 hours"
          description: "No anomalies detected in 6 hours. Verify detection is working correctly."
          runbook_url: "https://docs.example.com/runbooks/no-anomalies"

  - name: sentinel_storage
    interval: 30s
    rules:
      - alert: SentinelLowCacheHitRate
        expr: |
          (rate(sentinel_cache_hits_total[5m])
            / (rate(sentinel_cache_hits_total[5m]) + rate(sentinel_cache_misses_total[5m])))
            * 100 < 70
        for: 15m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanize }}% (threshold: 70%). Performance degradation possible."
          runbook_url: "https://docs.example.com/runbooks/low-cache-hit-rate"

      - alert: SentinelStorageSlowWrites
        expr: rate(sentinel_storage_writes_total[5m]) < 100
        for: 10m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "Storage write rate is low"
          description: "Writing only {{ $value | humanize }} records/sec to storage (expected: >100/sec)."
          runbook_url: "https://docs.example.com/runbooks/slow-storage"

  - name: sentinel_alerting
    interval: 30s
    rules:
      - alert: SentinelAlertDeliveryFailures
        expr: rate(sentinel_alert_failures_total[5m]) > 1
        for: 5m
        labels:
          severity: critical
          component: alerting
        annotations:
          summary: "Alert delivery failures"
          description: "Failing to deliver {{ $value | humanize }} alerts/sec. Alerts may be lost."
          runbook_url: "https://docs.example.com/runbooks/alert-failures"

      - alert: SentinelHighDeduplicationRate
        expr: |
          (rate(sentinel_alerts_deduplicated_total[5m])
            / (rate(sentinel_alerts_sent_total[5m]) + rate(sentinel_alerts_deduplicated_total[5m])))
            * 100 > 80
        for: 15m
        labels:
          severity: info
          component: alerting
        annotations:
          summary: "High alert deduplication rate"
          description: "{{ $value | humanize }}% of alerts are being deduplicated. Review deduplication window."
          runbook_url: "https://docs.example.com/runbooks/high-deduplication"

      - alert: SentinelRabbitMQConnectionDown
        expr: sentinel_rabbitmq_publishes_total offset 5m == sentinel_rabbitmq_publishes_total
        for: 5m
        labels:
          severity: critical
          component: alerting
        annotations:
          summary: "RabbitMQ connection appears down"
          description: "No messages published to RabbitMQ in 5 minutes."
          runbook_url: "https://docs.example.com/runbooks/rabbitmq-down"

      - alert: SentinelWebhookFailures
        expr: rate(sentinel_webhook_failures_total[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          component: alerting
        annotations:
          summary: "Webhook delivery failures"
          description: "Webhook failures at {{ $value | humanize }} failures/sec."
          runbook_url: "https://docs.example.com/runbooks/webhook-failures"

  - name: sentinel_kafka
    interval: 30s
    rules:
      - alert: SentinelKafkaConsumerLag
        expr: rate(sentinel_kafka_messages_consumed_total[5m]) == 0
        for: 5m
        labels:
          severity: critical
          component: ingestion
        annotations:
          summary: "Kafka consumer not consuming messages"
          description: "No messages consumed from Kafka in 5 minutes. Consumer may be down or stuck."
          runbook_url: "https://docs.example.com/runbooks/kafka-consumer-down"

      - alert: SentinelKafkaConsumptionErrors
        expr: rate(sentinel_kafka_consumption_errors_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
          component: ingestion
        annotations:
          summary: "Kafka consumption errors"
          description: "Kafka consumption errors at {{ $value | humanize }} errors/sec."
          runbook_url: "https://docs.example.com/runbooks/kafka-errors"

  - name: sentinel_baselines
    interval: 30s
    rules:
      - alert: SentinelBaselineUpdateFailures
        expr: sentinel_baseline_updates_total offset 15m == sentinel_baseline_updates_total
        for: 15m
        labels:
          severity: warning
          component: detection
        annotations:
          summary: "Baseline updates have stopped"
          description: "No baseline updates in 15 minutes. Detection accuracy may degrade."
          runbook_url: "https://docs.example.com/runbooks/baseline-updates-stopped"
